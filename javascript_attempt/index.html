<html>
    <head>
        <title>My first Three.js app</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>
    </head>
    <body>
        <script src="js/poly2tri.js"></script>
        <script src="js/jquery-2.1.4.min.js"></script>
        <script src="js/draggabilly.pkgd.min.js"></script>
        <script src="polygoncreation.js"></script>
        <script src="kirkpatpointloc.js"></script>
        <script src="layeredfdg.js"></script>
        <script>
            kptstruct = null;
            fdg = null;
            NS ="http://www.w3.org/2000/svg";
            CANVAS_WIDTH = 1200;
            CANVAS_HEIGHT = 600;
            MARGIN = 20;
            CENTER_LEFT_X = CANVAS_WIDTH/4;
            CENTER_LEFT_Y = CANVAS_HEIGHT/2;
            CENTER = [CENTER_LEFT_X,  CENTER_LEFT_Y];

            svg = document.createElementNS(NS, "svg");
            svg.setAttribute("id", "polygon_svg");
            svg.setAttribute("width", CANVAS_WIDTH);
            svg.setAttribute("height", CANVAS_HEIGHT);
            document.body.appendChild(svg);

            // create polygon
            testPointsLarge = new Array();
            testPointsLarge.push(new PolyPoint(413, 185));
            testPointsLarge.push(new PolyPoint(198, 44));
            testPointsLarge.push(new PolyPoint(66, 265));
            testPointsLarge.push(new PolyPoint(96, 433));
            testPointsLarge.push(new PolyPoint(250, 311));
            testPointsLarge.push(new PolyPoint(238, 178));
            testPointsLarge.push(new PolyPoint(434, 351));
            testPointsLarge.push(new PolyPoint(575, 193));
            testPointsLarge.push(new PolyPoint(484, 82));
            testPointsSmall = new Array();
            testPointsSmall.push(new PolyPoint(106, 60));
            testPointsSmall.push(new PolyPoint(73, 124));
            testPointsSmall.push(new PolyPoint(122, 110));
            testPointsSmall.push(new PolyPoint(91, 179));
            testPointsSmall.push(new PolyPoint(45, 128));
            testPointsSmall.push(new PolyPoint(47, 225));
            testPointsSmall.push(new PolyPoint(185, 199));
            testPointsSmall.push(new PolyPoint(168, 43));
            testPointsSmall.push(new PolyPoint(145, 76));
            testPointsSmall.push(new PolyPoint(101, 13));
            testPoints = testPointsSmall;
            DEMO = true;

            function createPolygon() {
                console.log("Create polygon");
                if(!DEMO){
                    poly = new Poly(svg, callbackOnComplete);
                } else{
                    var updatedPoints = "";
                    for(var i=0; i < testPoints.length; i++){
                        // move point to center
                        updatedPoints += 
                            testPoints[i].x + ", " + testPoints[i].y + " ";
                    }

                    var tpElement = document.createElementNS(NS, "polygon");
                    tpElement.setAttribute("points", updatedPoints);
                    tpElement.setAttribute("fill-opacity", "0");
                    tpElement.setAttribute("stroke", "rgb(0,0,0)");
                    svg.appendChild(tpElement);
                    poly = tpElement;
                }
            }

            function repositionPolygon(){
                // reposition polygon to center of screen
                console.log("Reposition polygon");
                movePolygon(poly, CENTER);

                maxPoints = getMaxPoints(poly.points);
                wRatio = CANVAS_WIDTH/maxPoints[4];
                hRatio = CANVAS_HEIGHT/maxPoints[5];
                scaleRatio = Math.min(wRatio, hRatio);
                if(scaleRatio < 1){
                    console.log("Scaling poly with ratio: " + scaleRatio);
                    scalePolygon(poly, CENTER, scaleRatio);
                }
                polyPoints = poly.points;

                return poly;
            }


            CREATE_POLYGON = "createPoly";
            SETUP_TRIANGULATION = "setupTris";
            DRAW_TRIANGULATION = "drawTris";

            MAX_COUNT = 100;
            counter = 0;
            stage = CREATE_POLYGON;
            subStage = 0;
            function draw(){
                console.log("Stage is " + stage);
                switch(stage){
                    case CREATE_POLYGON:
                        // at this point, poly is still custom
                        // load into an svg polygon
                        if(DEMO){
                            repositionPolygon();
                            stage = SETUP_TRIANGULATION;
                        }else{
                            if(poly.isFinished){
                                // reposition polygon
                                while(svg.firstChild){
                                    svg.removeChild(svg.firstChild);
                                }
                                poly = loadPolygon(svg, poly.points);
                                repositionPolygon();
                                stage = SETUP_TRIANGULATION;
                            }
                        }
                        break;
                    case SETUP_TRIANGULATION:
                        switch(subStage){
                            case 0:
                                // triangulate main polygon
                                if(counter >= MAX_COUNT){
                                    console.log("Triangulate main poly");
                                    poly.setAttribute("visibility", "hidden");
                                    kptstruct = new KPTStruct(svg);
                                    polytris = triangulate(poly.points);
                                    kptstruct.addTris(polytris, true, true);
                                    counter = 0;
                                    subStage++;
                                }
                                counter++;
                                break;
                            case 1:
                                // draw and triangulate convex hull
                                // triangulate polygon convex hull
                                //polyhull = getConvexHull(poly); 
                                //hulltris = 
                                //triangulate(polyhull.points, poly.points);
                                //kptstruct.addTris(hulltris, true);
                                //fdg.addNodes(hulltris);
                                subStage++;
                                break;
                            case 2:
                                // draw and triangulate outer triangle
                                if(counter >= MAX_COUNT){
                                    console.log("Draw outer tri");
                                    outerTri = drawOuterTriangle(svg, CENTER);
                                    counter = 0;
                                    subStage++;
                                }
                                counter++;
                                break;
                            case 3:
                                if(counter >= MAX_COUNT){
                                    console.log("Triangulate outer tri");
                                    outertris = triangulate(
                                                outerTri.points, poly.points);
                                    kptstruct.addTris(outertris);
                                    counter = 0;
                                    subStage++;
                                }
                                counter++;
                                break;
                            case 4:
                                // find and remove ILDVs
                                while(kptstruct.markILDV()){
                                    kptstruct.markILDV();
                                    removedToNewTris = kptstruct.removeILDV();
                                }

                                // create graph layout and load triangles
                                fdg = new LayeredFDG();
                                fdg.init();
                                loadNodes(kptstruct.tris, kptstruct.depth);

                                // move to next stage
                                subStage = 0;
                                stage = DRAW_TRIANGULATION;
                                break;
                        }
                        break;
                    case DRAW_TRIANGULATION:
                        if(counter >= MAX_COUNT && subStage < fdg.maxLevel){
                            console.log("UPDATING LEVEL: " + stage);
                            subStage++;
                            counter = 0;
                        } 
                        console.log("SUBSTAGE: " + subStage);
                        kptstruct.render(subStage);
                        fdg.render(subStage);
                        counter++;
                        break;
                }
                window.requestAnimationFrame(draw);
            }

            var $draggable = $('.draggable').draggabilly({
                      // options...
            })

            createPolygon();
            draw();

        </script>
    </body>
</html>
