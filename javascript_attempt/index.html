<html>
    <head>
        <title>My first Three.js app</title>
        <style>
            body { margin: 0; }
            canvas { width: 100%; height: 100% }
        </style>
    </head>
    <body>
        <script src="js/poly2tri.js"></script>
        <script src="polygoncreation.js"></script>
        <script src="kirkpatpointloc.js"></script>
        <script src="layeredfdg.js"></script>
        <script>
            kptstruct = null;
            NS ="http://www.w3.org/2000/svg";
            CANVAS_WIDTH = 1200;
            CANVAS_HEIGHT = 600;
            MARGIN = 20;
            MIN_LEFT_X = MARGIN;
            MIN_LEFT_Y = MARGIN;
            CENTER_LEFT_X = CANVAS_WIDTH/4;
            CENTER_LEFT_Y = CANVAS_HEIGHT/2;
            MAX_LEFT_X = CANVAS_WIDTH/2 - MARGIN;
            MAX_LEFT_Y = CANVAS_HEIGHT - MARGIN;
            MIN_RIGHT_X = CANVAS_WIDTH/2 + MARGIN;
            MIN_RIGHT_Y = MARGIN;
            CENTER_RIGHT_X = CANVAS_WIDTH/4 * 3;
            CENTER_RIGHT_Y = CANVAS_HEIGHT/2;
            MAX_RIGHT_X = CANVAS_WIDTH - MARGIN;
            MAX_RIGHT_Y = CANVAS_HEIGHT - MARGIN;

            svg = document.createElementNS(NS, "svg");
            svg.setAttribute("id", "polygon_svg");
            svg.setAttribute("width", CANVAS_WIDTH);
            svg.setAttribute("height", CANVAS_HEIGHT);
            document.body.appendChild(svg);

            // create polygon
            testPointsLarge = new Array();
            testPointsLarge.push(new PolyPoint(413, 185));
            testPointsLarge.push(new PolyPoint(198, 44));
            testPointsLarge.push(new PolyPoint(66, 265));
            testPointsLarge.push(new PolyPoint(96, 433));
            testPointsLarge.push(new PolyPoint(250, 311));
            testPointsLarge.push(new PolyPoint(238, 178));
            testPointsLarge.push(new PolyPoint(434, 351));
            testPointsLarge.push(new PolyPoint(575, 193));
            testPointsLarge.push(new PolyPoint(484, 82));
            testPointsSmall = new Array();
            testPointsSmall.push(new PolyPoint(106, 60));
            testPointsSmall.push(new PolyPoint(73, 124));
            testPointsSmall.push(new PolyPoint(122, 110));
            testPointsSmall.push(new PolyPoint(91, 179));
            testPointsSmall.push(new PolyPoint(45, 128));
            testPointsSmall.push(new PolyPoint(47, 225));
            testPointsSmall.push(new PolyPoint(185, 199));
            testPointsSmall.push(new PolyPoint(168, 43));
            testPointsSmall.push(new PolyPoint(145, 76));
            testPointsSmall.push(new PolyPoint(101, 13));

            //poly = createPolygon(repositionPolygon);
            repositionPolygon(testPointsSmall);

            function createPolygon(callbackOnComplete) {
                console.log("Create polygon");
                var polyView = new Poly(svg, callbackOnComplete);
                window.requestAnimationFrame(draw);
            }

            function repositionPolygon(polyPoints){
                console.log("Reposition polygon");

                // remove all elements from svg
                while(svg.firstChild){
                    svg.removeChild(svg.firstChild);
                }
                poly = loadPolygon(svg, polyPoints);
                centroid = getCentroid(polyPoints);

                // draw outer triangle
                outerTri = drawOuterTriangle(svg, centroid);
                oTriCentroid = getCentroid(outerTri.points);
                oTriMaxPoints = getMaxPoints(outerTri.points);
                oTriMaxPoints[4] = oTriMaxPoints[4]/2;
                oTriMaxPoints[5] = oTriMaxPoints[5]/2;
                console.log("Max points adjusted " + oTriMaxPoints[4] + " " + oTriMaxPoints[5]);

                maxPoints = getMaxPoints(polyPoints);
                transformAttr = "";

                if(maxPoints[4] > oTriMaxPoints[4] ||
                    maxPoints[5] > oTriMaxPoints[5]){
                    wRatio = oTriMaxPoints[4]/maxPoints[4];
                    hRatio = oTriMaxPoints[5]/maxPoints[5];
                    scaleRatio = Math.max(wRatio, hRatio);
                    console.log("Scaling poly by " + scaleRatio);
                    transformAttr += 'scale(' + scaleRatio + ') ';
                }

                var xOffset = 0;//oTriCentroid[0] - centroid[0];
                var yOffset = 0;//oTriCentroid[1] - centroid[1];
                xOffset = CENTER_LEFT_X - centroid[0];
                yOffset = CENTER_LEFT_Y - centroid[1];

                transformAttr +=  
                    'translate(' + xOffset + ',' + yOffset + ') ';
                console.log("Transform " + transformAttr);
                poly.setAttribute('transform', transformAttr);
                outerTri.setAttribute('transform', transformAttr);
                // scale if polygon width/height is greater than outer tri

                kptstruct = new KPTStruct(svg);

                // triangulate polygon and add to kpt and fdg
                polytris = triangulate(poly.points);
                kptstruct.addTris(polytris, true);
                draw();

                // triangulate polygon convex hull
                //polyhull = getConvexHull(poly); 
                //hulltris = triangulate(polyhull.points, poly.points);
                //kptstruct.addTris(hulltris, true);
                //fdg.addNodes(hulltris);

                // triangulate outer triangle
                outertris = triangulate(outerTri.points, poly.points);
                kptstruct.addTris(outertris);

                while(kptstruct.markILDV()){
                    removedToNewTris = kptstruct.removeILDV();
                    kptstruct.render();
                }

                fdg = new LayeredFDG();
                fdg.init();
                fdg.loadNodes(kptstruct.tris, kptstruct.depth);

                return poly;
            }

            function draw() {
                window.requestAnimationFrame(draw);
            }

        </script>
    </body>
</html>
